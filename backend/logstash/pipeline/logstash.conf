input {
  beats {
    port => 5044
  }
}

filter {
  if [fields][service] == "peace-backend" {
    # Parse JSON logs if they are in JSON format
    if [message] =~ /^\{.*\}$/ {
      json {
        source => "message"
        target => "log_data"
      }
    }
    
    # Add trace correlation
    if [log_data][trace_id] {
      mutate {
        add_field => { "[@metadata][trace_id]" => "%{[log_data][trace_id]}" }
        add_field => { "trace_id" => "%{[log_data][trace_id]}" }
      }
    }
    
    # Parse timestamp
    if [log_data][timestamp] {
      date {
        match => [ "[log_data][timestamp]", "ISO8601" ]
        target => "@timestamp"
      }
    }
    
    # Add service information
    mutate {
      add_field => { "service_name" => "peace-backend" }
      add_field => { "environment" => "development" }
    }
    
    # Parse log level
    if [log_data][level] {
      mutate {
        add_field => { "log_level" => "%{[log_data][level]}" }
      }
    }
    
    # Parse log message
    if [log_data][message] {
      mutate {
        add_field => { "log_message" => "%{[log_data][message]}" }
      }
    }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "peace-logs-%{+YYYY.MM.dd}"
  }
}
